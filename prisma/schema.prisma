generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Administrateur {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  telephone String?
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clients   Client[]
  gies      GIE[]

  @@map("administrateurs")
}

model Avis {
  id        String   @id @default(cuid())
  clientId  String
  nom       String?
  rating    Int      @default(5) // note de 1 à 5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId], map: "idx_avis_gie_client")
  @@map("Avite_siteWeb")
}

model AvisProduit {
  id        String   @id @default(cuid())
  clientId  String
  produitId String
  rating    Int      @default(5) // note de 1 à 5
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    Client   @relation(fields: [clientId], references: [id])
  produit   Produit  @relation(fields: [produitId], references: [id])
  @@index([produitId], map: "idx_avis_produit_produit")
  @@index([clientId], map: "idx_avis_produit_client")
  @@map("avis_produit")
}

model GIE {
  id               String         @id @default(cuid())
  nom              String
  description      String?
  adresse          String?
  telephone        String?        @unique
  email            String?
  password         String
  logo             String?
  url              String?
  membre           Int?
  Annee            DateTime?
  specialite       Int?
  statut           StatutGIE      @default(ACTIF)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  administrateurId String
  regionId         String?
  administrateur   Administrateur @relation(fields: [administrateurId], references: [id], onDelete: Cascade)
  regions          regions?       @relation(fields: [regionId], references: [id])
  produits         Produit[]

  @@map("gies")
}

model Client {
  id               String         @id @default(cuid())
  email            String?        @unique
  password         String
  nom              String
  prenom           String
  telephone        String
  adresse          String?
  statut           StatutClient   @default(ACTIF)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  administrateurId String
  administrateur   Administrateur @relation(fields: [administrateurId], references: [id], onDelete: Cascade)
  commandes        Commande[]
  avis             Avis[]
  avisProduit      AvisProduit[]
  // <-- avis produits du client

  @@map("clients")
}

model Categorie {
  id          String    @id @default(cuid())
  nom         String    @unique
  description String?
  conservation String?
  couleur     String?   @default("#3B82F6")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  image       String?
  produits    Produit[]

  @@map("categories")
}

model Produit {
  id             String          @id @default(cuid())
  nom            String
  quantite       String          @default("")
  description    String?
  prix           Float
  stock          Int             @default(0)
  image          String?
  statut         StatutProduit   @default(DISPONIBLE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  gieId          String
  categorieId    String?
  panierProduits PanierProduit[]
  categorie      Categorie?      @relation(fields: [categorieId], references: [id])
  gie            GIE             @relation(fields: [gieId], references: [id], onDelete: Cascade)
  avisProduit    AvisProduit[]

  @@map("produits")
}

model Commande {
  id                String          @id @default(cuid())
  numero            String          @unique
  montant           Float
  statut            StatutCommande  @default(EN_ATTENTE)
  dateCommande      DateTime        @default(now())
  dateLivraison     DateTime?
  adresseLivraison  String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  clientId          String
  fraisLivraison    Float           @default(0)
  regionLivraisonId String?
  livreurId         String?
  client            Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  livreurs          livreurs?       @relation(fields: [livreurId], references: [id])
  regions           regions?        @relation(fields: [regionLivraisonId], references: [id])
  paiement          Paiement?
  panierProduits    PanierProduit[]

  @@map("commandes")
}

model Paiement {
  id             String          @id @default(cuid())
  montant        Float
  methode        MethodePaiement
  statut         StatutPaiement  @default(EN_ATTENTE)
  reference      String?         @unique
  datePaiement   DateTime        @default(now())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  commandeId     String          @unique
  fraisLivraison Float           @default(0)
  commande       Commande        @relation(fields: [commandeId], references: [id], onDelete: Cascade)

  @@map("paiements")
}

model PanierProduit {
  id               String           @id @default(cuid())
  quantite         Int
  prixUnitaire     Float
  createdAt        DateTime         @default(now())
  commandeId       String
  produitId        String
  statutGIE        StatutGIEProduit @default(EN_ATTENTE)
  dateConfirmation DateTime?
  updatedAt        DateTime         @default(now()) @updatedAt
  commande         Commande         @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  produit          Produit          @relation(fields: [produitId], references: [id], onDelete: Cascade)

  @@unique([commandeId, produitId])
  @@index([produitId, statutGIE], map: "idx_panier_produits_gie_statut")
  @@index([statutGIE], map: "idx_panier_produits_statut_gie")
  @@map("panier_produits")
}

model adresses {
  id             String   @id
  nom            String
  description    String?
  codePostal     String?
  fraisLivraison Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  regionId       String
  regions        regions  @relation(fields: [regionId], references: [id], onDelete: Cascade)
}

model livreurs {
  id        String        @id
  nom       String
  prenom    String
  email     String        @unique
  telephone String
  password  String
  statut    StatutLivreur @default(DISPONIBLE)
  regionId  String?
  createdAt DateTime      @default(now())
  updatedAt DateTime
  commandes Commande[]
  regions   regions?      @relation(fields: [regionId], references: [id])
}

model regions {
  id                    String     @id
  nom                   String     @unique
  description           String?
  fraisLivraisonInterne Float      @default(500)
  fraisLivraisonExterne Float      @default(2000)
  createdAt             DateTime   @default(now())
  updatedAt             DateTime
  adresses              adresses[]
  commandes             Commande[]
  gies                  GIE[]
  livreurs              livreurs[]
}

enum Role {
  ADMIN
  SUPER_ADMIN
}

enum StatutGIE {
  ACTIF
  INACTIF
  SUSPENDU
}

enum StatutClient {
  ACTIF
  INACTIF
  BLOQUE
}

enum StatutProduit {
  DISPONIBLE
  RUPTURE
  HORS_STOCK
}

enum StatutCommande {
  EN_ATTENTE
  CONFIRMEE
  EN_PREPARATION
  EXPEDIEE
  LIVREE
  ANNULEE
}

enum StatutPaiement {
  EN_ATTENTE
  VALIDE
  ECHEC
  REMBOURSE
}

enum MethodePaiement {
  CARTE_BANCAIRE
  VIREMENT
  ESPECES
  MOBILE_MONEY
  PAIEMENT_A_LA_LIVRAISON
  WAVE
  ORANGE_MONEY
}

enum StatutGIEProduit {
  EN_ATTENTE
  EN_PREPARATION
  PRET
  ANNULE
}

enum StatutLivreur {
  DISPONIBLE
  EN_LIVRAISON
  INDISPONIBLE
  BLOQUE
}
